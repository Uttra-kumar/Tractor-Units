<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Payment & Trolley Records System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4bb543;
            --warning: #ffcc00;
            --danger: #dc3545;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --trolley-color: #FF5722;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 0;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            position: relative;
            z-index: 1;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 36px;
        }
        
        .logo h1 {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }
        
        .user-info img {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        nav {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.8rem;
            margin-top: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        nav ul {
            display: flex;
            justify-content: center;
            list-style: none;
        }
        
        nav ul li {
            margin: 0 15px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.3s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        nav ul li a:hover,
        nav ul li a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Data Type Toggle */
        .data-type-toggle {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }
        
        .data-type-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .data-type-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        .data-type-btn:not(.active):hover {
            background: var(--light-gray);
        }
        
        .data-type-btn.trolley.active {
            background: linear-gradient(135deg, var(--trolley-color), #E64A19);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            border-left: 5px solid var(--primary);
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateX(5px);
        }
        
        .stat-item:nth-child(2) {
            border-left-color: var(--success);
        }
        
        .stat-item:nth-child(3) {
            border-left-color: var(--accent);
        }
        
        .stat-item:nth-child(4) {
            border-left-color: var(--warning);
        }
        
        .stat-info h3 {
            font-size: 15px;
            color: var(--gray);
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 26px;
            font-weight: 800;
            color: var(--dark);
        }
        
        .stat-icon {
            width: 55px;
            height: 55px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            font-size: 22px;
        }
        
        .trolley .stat-icon {
            background: rgba(255, 87, 34, 0.1);
            color: var(--trolley-color);
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 15px;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid var(--light-gray);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fdfdfd;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.2);
            background: white;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(67, 97, 238, 0.3);
        }
        
        .btn-trolley {
            background: linear-gradient(135deg, var(--trolley-color), #E64A19);
            color: white;
        }
        
        .btn-trolley:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(255, 87, 34, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #3a9c33);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(75, 181, 67, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c82333);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 14px rgba(220, 53, 69, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }
        
        .table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid var(--light-gray);
        }
        
        .filters {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }
        
        th {
            padding: 18px;
            text-align: left;
            font-weight: 700;
            color: var(--dark);
            border-bottom: 1px solid var(--light-gray);
            font-size: 15px;
        }
        
        .table-container.trolley th {
            background: linear-gradient(135deg, rgba(255, 87, 34, 0.1), rgba(230, 74, 25, 0.1));
        }
        
        td {
            padding: 18px;
            border-bottom: 1px solid var(--light-gray);
            font-size: 15px;
            font-weight: 600; /* Bold text for data */
        }
        
        tbody tr {
            transition: background 0.3s ease;
        }
        
        tbody tr:hover {
            background: rgba(67, 97, 238, 0.04);
        }
        
        .table-container.trolley tbody tr:hover {
            background: rgba(255, 87, 34, 0.04);
        }
        
        .status {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 700;
        }
        
        .status-completed {
            background: rgba(75, 181, 67, 0.15);
            color: var(--success);
        }
        
        .status-pending {
            background: rgba(255, 204, 0, 0.15);
            color: #b38f00;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .edit-btn {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .edit-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }
        
        .delete-btn {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        .delete-btn:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.1);
        }
        
        .export-btn {
            background: rgba(75, 181, 67, 0.1);
            color: var(--success);
        }
        
        .export-btn:hover {
            background: var(--success);
            color: white;
            transform: scale(1.1);
        }
        
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-top: 1px solid var(--light-gray);
        }
        
        .page-info {
            font-size: 15px;
            color: var(--gray);
        }
        
        .page-controls {
            display: flex;
            gap: 12px;
        }
        
        .page-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--light-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .page-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .page-btn:hover:not(.active) {
            background: var(--light-gray);
        }
        
        footer {
            text-align: center;
            padding: 25px;
            margin-top: 40px;
            color: var(--gray);
            font-size: 15px;
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }
        
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            background-color: #ffecec;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffcdd2;
        }
        
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        
        .report-section {
            display: none;
        }
        
        .report-section.active {
            display: block;
        }
        
        .report-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            nav ul {
                flex-direction: column;
                align-items: center;
            }
            
            nav ul li {
                margin: 5px 0;
            }
            
            .filters {
                flex-direction: column;
                width: 100%;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .table-header {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }
            
            .actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .page-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-tractor"></i>
                    <h1>Tractor Fleet Management</h1>
                </div>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=4361ee&color=fff" alt="User">
                    <span id="admin-name">Loading...</span>
                </div>
            </div>
            
            <nav>
                <ul>
                    <li><a href="admin-alluser.html"><i class="fas fa-arrow-left"></i> Back</a></li>
                    <li><a href="#" class="active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#" data-section="reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
                    <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </nav>
        </header>
        
        <!-- Data Type Toggle -->
        <div class="data-type-toggle">
            <button id="paymentToggle" class="data-type-btn active">
                <i class="fas fa-credit-card"></i> Payment Management
            </button>
            <button id="trolleyToggle" class="data-type-btn trolley">
                <i class="fas fa-shopping-cart"></i> Trolley Management
            </button>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboard" class="report-section active">
            <div class="dashboard">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-pie"></i> <span id="statsTitle">Payment</span> Statistics</h2>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-info">
                                <h3 id="totalLabel">Total Payments</h3>
                                <div id="total-payments" class="stat-value">‚Çπ0</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-info">
                                <h3 id="completedLabel">Completed Payments</h3>
                                <div id="completed-payments" class="stat-value">‚Çπ0</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-info">
                                <h3 id="pendingLabel">Pending Payments</h3>
                                <div id="pending-payments" class="stat-value">‚Çπ0</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-info">
                                <h3 id="monthLabel">This Month</h3>
                                <div id="month-payments" class="stat-value">‚Çπ0</div>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-plus-circle"></i> Add <span id="formTitle">Payment</span> Record</h2>
                    </div>
                    <form id="payment-form">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label for="payment-id">User ID</label>
                                <input type="number" id="payment-id" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="payment-name">Name</label>
                                <input type="text" id="payment-name" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="payment-paid" id="paidLabel">Paid Amount (‚Çπ)</label>
                                <input type="number" id="payment-paid" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="payment-remain" id="remainLabel">Remain Amount (‚Çπ)</label>
                                <input type="number" id="payment-remain" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="payment-total" id="totalAmountLabel">Total Amount (‚Çπ)</label>
                                <input type="number" id="payment-total" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save"></i> Submit
                            </button>
                            <button type="reset" class="btn btn-outline">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="loading" class="loading">Loading payment data...</div>
            <div id="error" class="error" style="display: none;"></div>
            
            <!-- Payment Table -->
            <div class="table-container" id="paymentTable">
                <div class="table-header">
                    <h2 class="card-title"><i class="fas fa-credit-card"></i> Payment Records</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="paymentFilterId">ID</label>
                            <input type="text" id="paymentFilterId" class="form-control" placeholder="Filter by ID">
                        </div>
                        <div class="filter-group">
                            <label for="paymentFilterName">Name</label>
                            <input type="text" id="paymentFilterName" class="form-control" placeholder="Filter by Name">
                        </div>
                        <div class="filter-group">
                            <label for="paymentFilterDate">Date</label>
                            <input type="date" id="paymentFilterDate" class="form-control">
                        </div>
                        <div class="actions">
                            <button class="btn btn-success" id="exportAllBtn">
                                <i class="fas fa-file-pdf"></i> Export All to PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table id="payment-table" style="display:none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Paid Amount (‚Çπ)</th>
                                <th>Remain (‚Çπ)</th>
                                <th>Total Amount (‚Çπ)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payment-body"></tbody>
                    </table>
                </div>
                
                <div class="pagination">
                    <div class="page-info">Showing 0 entries</div>
                    <div class="page-controls">
                        <div class="page-btn"><i class="fas fa-chevron-left"></i></div>
                        <div class="page-btn active">1</div>
                        <div class="page-btn">2</div>
                        <div class="page-btn">3</div>
                        <div class="page-btn">4</div>
                        <div class="page-btn">5</div>
                        <div class="page-btn"><i class="fas fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>
            
            <!-- Trolley Table -->
            <div class="table-container trolley" id="trolleyTable" style="display: none;">
                <div class="table-header">
                    <h2 class="card-title"><i class="fas fa-shopping-cart"></i> Trolley Records</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="trolleyFilterId">ID</label>
                            <input type="text" id="trolleyFilterId" class="form-control" placeholder="Filter by ID">
                        </div>
                        <div class="filter-group">
                            <label for="trolleyFilterName">Name</label>
                            <input type="text" id="trolleyFilterName" class="form-control" placeholder="Filter by Name">
                        </div>
                        <div class="filter-group">
                            <label for="trolleyFilterDate">Date</label>
                            <input type="date" id="trolleyFilterDate" class="form-control">
                        </div>
                        <div class="actions">
                            <button class="btn btn-trolley" id="exportTrolleyBtn">
                                <i class="fas fa-file-pdf"></i> Export All to PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table id="trolley-table" style="display:none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Paid Amount (‚Çπ)</th>
                                <th>Remain (‚Çπ)</th>
                                <th>Total Amount (‚Çπ)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trolley-body"></tbody>
                    </table>
                </div>
                
                <div class="pagination">
                    <div class="page-info">Showing 0 entries</div>
                    <div class="page-controls">
                        <div class="page-btn"><i class="fas fa-chevron-left"></i></div>
                        <div class="page-btn active">1</div>
                        <div class="page-btn">2</div>
                        <div class="page-btn">3</div>
                        <div class="page-btn">4</div>
                        <div class="page-btn">5</div>
                        <div class="page-btn"><i class="fas fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reports Section -->
        <div id="reports" class="report-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-bar"></i> <span id="reportTitle">Payment</span> Reports & Analytics</h2>
                </div>
                <div class="report-controls">
                    <div class="filter-group">
                        <label for="report-year">Select Year</label>
                        <select id="report-year" class="form-control">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="report-month">Select Month</label>
                        <select id="report-month" class="form-control">
                            <option value="all">All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" id="generate-report">
                            <i class="fas fa-file-pdf"></i> Generate PDF Report
                        </button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="paymentChart"></canvas>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-header">
                    <h2 class="card-title"><i class="fas fa-table"></i> Monthly <span id="summaryTitle">Payment</span> Summary</h2>
                </div>
                <div class="table-responsive">
                    <table id="report-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Total Amount</th>
                                <th>Paid Amount</th>
                                <th>Remaining Amount</th>
                                <th>Records Count</th>
                            </tr>
                        </thead>
                        <tbody id="report-body">
                            <!-- Report data will be inserted here -->
                        </tbody>
                        <tfoot>
                            <tr style="background-color: #f1f5f9; font-weight: bold;">
                                <td>GRAND TOTAL</td>
                                <td id="report-grand-total">‚Çπ0</td>
                                <td id="report-grand-paid">‚Çπ0</td>
                                <td id="report-grand-remain">‚Çπ0</td>
                                <td id="report-grand-count">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <footer>
            <p>¬© 2025 Tractor Fleet Management || Designed By <span style="color: #FF8200; font-weight: 600;">Uttra Patel</span></p>
            <p style="margin-top: 10px; font-size: 1rem;">
                <span style="background: rgba(0, 0, 0, 0.1); padding: 5px 10px; border-radius: 5px;">
                    Session expired is <span id="counter" style="display: inline-block; padding: 2px 8px; border-radius: 10px; background: linear-gradient(45deg, #ff6b6b, #ff8e53); color: white; font-weight: bold;">0s</span>
                </span>
            </p>
        </footer>
    </div>
    <script src="session.js"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://iydamvrlxtwsnqvflaxq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZGFtdnJseHR3c25xdmZsYXhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTczMTIsImV4cCI6MjA3MzY3MzMxMn0.Z8m6XGyu9wsN_UJ8EZYr12BRemsO12_U8EEZ9JizQ6w';
        const client = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // DOM elements
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        const paymentForm = document.getElementById("payment-form");
        const paymentTable = document.getElementById("payment-table");
        const paymentBody = document.getElementById("payment-body");
        const trolleyTable = document.getElementById("trolley-table");
        const trolleyBody = document.getElementById("trolley-body");
        let paymentChart = null;
        
        // Current data type (payment or trolley)
        let currentDataType = 'payment';
        
        // Text elements to update based on data type
        const statsTitle = document.getElementById('statsTitle');
        const totalLabel = document.getElementById('totalLabel');
        const completedLabel = document.getElementById('completedLabel');
        const pendingLabel = document.getElementById('pendingLabel');
        const monthLabel = document.getElementById('monthLabel');
        const formTitle = document.getElementById('formTitle');
        const paidLabel = document.getElementById('paidLabel');
        const remainLabel = document.getElementById('remainLabel');
        const totalAmountLabel = document.getElementById('totalAmountLabel');
        const submitBtn = document.getElementById('submitBtn');
        const reportTitle = document.getElementById('reportTitle');
        const summaryTitle = document.getElementById('summaryTitle');
        
        // Toggle elements
        const paymentToggle = document.getElementById('paymentToggle');
        const trolleyToggle = document.getElementById('trolleyToggle');
        
        // Table containers
        const paymentTableContainer = document.getElementById('paymentTable');
        const trolleyTableContainer = document.getElementById('trolleyTable');
        
        // Update UI based on data type
        function updateUIText() {
            const isPayment = currentDataType === 'payment';
            const typeText = isPayment ? 'Payment' : 'Trolley';
            
            // Update titles and labels
            statsTitle.textContent = typeText;
            totalLabel.textContent = `Total ${typeText}s`;
            completedLabel.textContent = `Completed ${typeText}s`;
            pendingLabel.textContent = `Pending ${typeText}s`;
            monthLabel.textContent = `This Month`;
            formTitle.textContent = typeText;
            paidLabel.textContent = `Paid Amount (‚Çπ)`;
            remainLabel.textContent = `Remain Amount (‚Çπ)`;
            totalAmountLabel.textContent = `Total Amount (‚Çπ)`;
            reportTitle.textContent = typeText;
            summaryTitle.textContent = typeText;
            
            // Update button text
            submitBtn.innerHTML = `<i class="fas fa-save"></i> Submit`;
            
            // Update toggle button styles
            if (isPayment) {
                paymentToggle.classList.add('active');
                trolleyToggle.classList.remove('active');
                paymentTableContainer.style.display = 'block';
                trolleyTableContainer.style.display = 'none';
            } else {
                paymentToggle.classList.remove('active');
                trolleyToggle.classList.add('active');
                paymentTableContainer.style.display = 'none';
                trolleyTableContainer.style.display = 'block';
            }
        }
        
        // Format number as Indian currency
        function formatIndianCurrency(amount) {
    // If undefined or null ‚Üí treat as 0
    amount = Number(amount) || 0;

    return '‚Çπ' + amount
        .toFixed(0)
        .replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

        
        // Fetch admin name from database
        async function fetchAdminName() {
            try {
                // This is a placeholder - you would need to adjust based on your actual table structure
                const { data, error } = await client
                    .from('admin') // Adjust table name as needed
                    .select('name')
                    .eq('id', 716900) // Adjust ID as needed
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    document.getElementById('admin-name').textContent = data.name;
                }
            } catch (error) {
                console.error('Error fetching admin name:', error);
                document.getElementById('admin-name').textContent = 'Admin User';
            }
        }
        
        // Payment form submission
        paymentForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const id = parseInt(document.getElementById("payment-id").value);
            const name = document.getElementById("payment-name").value;
            const remain = parseInt(document.getElementById("payment-remain").value);
            const paid_amount = parseInt(document.getElementById("payment-paid").value);
            let total_amount = parseInt(document.getElementById("payment-total").value);
            
            total_amount = paid_amount + remain;
            // Auto Date + Day
            const today = new Date();
            const date = today.toISOString().split("T")[0]; // YYYY-MM-DD
            const day = today.toLocaleDateString("en-US", { weekday: "long" }); // e.g. Thursday
            
            const tableName = currentDataType === 'payment' ? 'admin-singePay' : 'admin-trollysingpay';
            
            const { error } = await supabase
                .from(tableName)
                .upsert([{ id, name, paid_amount, remain, total_amount, date, day }]);
            
            if (error) {
                alert("‚ùå Error: " + error.message);
            } else {
                alert(`‚úÖ ${currentDataType.charAt(0).toUpperCase() + currentDataType.slice(1)} record saved!`);
                paymentForm.reset();
                fetchPayData();
            }
        });
        
        // Fetch payment data
        // Fetch payment data
async function fetchPayData() {
    try {
        loadingElement.style.display = 'block';
        errorElement.style.display = 'none';
        
        const tableName = currentDataType === 'payment' ? 'admin-singePay' : 'admin-trollysingpay';
        
        const { data, error } = await client
            .from(tableName)
            .select('*')
            .order('date', { ascending: false });

        if (error) throw error;
        
        // Check if data is valid array
        if (!data || !Array.isArray(data)) {
            console.error('Invalid data format:', data);
            if (currentDataType === 'payment') {
                paymentTable.style.display = "none";
            } else {
                trolleyTable.style.display = "none";
            }
            loadingElement.textContent = `No ${currentDataType} records found`;
            updateStatistics([]); // Pass empty array
            return;
        }

        if (data.length === 0) {
            if (currentDataType === 'payment') {
                paymentTable.style.display = "none";
            } else {
                trolleyTable.style.display = "none";
            }
            loadingElement.textContent = `No ${currentDataType} records found`;
            updateStatistics([]); // Pass empty array
            return;
        }
        
        fetchRecords(data);
        updateStatistics(data);
        updateReports(data);
        
    } catch (error) {
        console.error('Fetch error:', error);
        showError(`Error fetching ${currentDataType} data: ` + error.message);
    }
}
        
        // Update statistics
        // Update statistics
function updateStatistics(data) {
    // Ensure data is an array
    if (!data || !Array.isArray(data)) {
        data = [];
    }
    
    const total = data.reduce((sum, item) => sum + (Number(item.total_amount) || 0), 0);
    const completed = data.reduce((sum, item) => sum + (Number(item.paid_amount) || 0), 0);
    const pending = data.reduce((sum, item) => sum + (Number(item.remain) || 0), 0);
    
    // Calculate this month's payments
    const currentMonth = new Date().getMonth() + 1;
    const currentYear = new Date().getFullYear();
    const monthPayments = data
        .filter(item => {
            if (!item.date) return false;
            try {
                const itemDate = new Date(item.date);
                return itemDate.getMonth() + 1 === currentMonth && itemDate.getFullYear() === currentYear;
            } catch (e) {
                return false;
            }
        })
        .reduce((sum, item) => sum + (Number(item.total_amount) || 0), 0);
    
    document.getElementById('total-payments').textContent = formatIndianCurrency(total);
    document.getElementById('completed-payments').textContent = formatIndianCurrency(completed);
    document.getElementById('pending-payments').textContent = formatIndianCurrency(pending);
    document.getElementById('month-payments').textContent = formatIndianCurrency(monthPayments);
}
        
        // Display records in table
        async function fetchRecords(data) {
            if (currentDataType === 'payment') {
                paymentBody.innerHTML = "";
            } else {
                trolleyBody.innerHTML = "";
            }
            
            if (!data || !Array.isArray(data) || data.length === 0) {
                if (currentDataType === 'payment') {
                    paymentTable.style.display = "none";
                } else {
                    trolleyTable.style.display = "none";
                }
                return;
            }
            
            if (currentDataType === 'payment') {
                paymentTable.style.display = "table";
            } else {
                trolleyTable.style.display = "table";
            }
            
            data.forEach(item => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><strong>${item.id}</strong></td>
                    <td><strong>${item.name}</strong></td>
                    <td><strong>${item.date || "-"}</strong></td>
                    <td><strong>${item.day || "-"}</strong></td>
                    <td><strong>${formatIndianCurrency(item.paid_amount)}</strong></td>
                    <td><strong>${formatIndianCurrency(item.remain)}</strong></td>
                    <td><strong>${formatIndianCurrency(item.total_amount)}</strong></td>
                    <td class="action-buttons">
                        <div class="action-btn edit-btn" title="Edit" onclick="editItem(${item.id}, '${item.name}', ${item.paid_amount}, ${item.remain}, ${item.total_amount})">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="action-btn export-btn" title="Export to PDF" onclick="exportSingleRecord(${item.id})">
                            <i class="fas fa-file-export"></i>
                        </div>
                        <div class="action-btn delete-btn" title="Delete" onclick="deleteItem(${item.id})">
                            <i class="fas fa-trash"></i>
                        </div>
                    </td>
                `;
                
                if (currentDataType === 'payment') {
                    paymentBody.appendChild(row);
                } else {
                    trolleyBody.appendChild(row);
                }
            });
            
            document.querySelector('.page-info').textContent = `Showing ${data.length} entries`;
            loadingElement.style.display = 'none';
        }
        
        // Fill Form for Editing
        function editItem(id, name, paid, remain, total) {
            document.getElementById("payment-id").value = id;
            document.getElementById("payment-name").value = name;
            document.getElementById("payment-paid").value = paid;
            document.getElementById("payment-remain").value = remain;
            document.getElementById("payment-total").value = total;
        }
        
        // Delete Record
        async function deleteItem(id) {
            if (!confirm("Are you sure you want to delete this record?")) return;
            
            const tableName = currentDataType === 'payment' ? 'admin-singePay' : 'admin-trollysingpay';
            
            const { error } = await client
                .from(tableName)
                .delete()
                .eq("id", id);
            
            if (error) {
                alert("‚ùå Delete Error: " + error.message);
            } else {
                alert(`üóëÔ∏è ${currentDataType.charAt(0).toUpperCase() + currentDataType.slice(1)} record deleted!`);
                fetchPayData();
            }
        }
        
        // Export All to PDF
        document.getElementById('exportAllBtn').addEventListener('click', async function() {
            try {
                const tableName = currentDataType === 'payment' ? 'admin-singePay' : 'admin-trollysingpay';
                
                const { data, error } = await client
                    .from(tableName)
                    .select('*')
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert(`No ${currentDataType} records to export`);
                    return;
                }
                
                exportToPDF(data, `All ${currentDataType.charAt(0).toUpperCase() + currentDataType.slice(1)} Records`);
            } catch (error) {
                alert("Error exporting data: " + error.message);
            }
        });
        
        // Export Trolley to PDF
        document.getElementById('exportTrolleyBtn').addEventListener('click', async function() {
            try {
                const { data, error } = await client
                    .from('admin-trollysingpay')
                    .select('*')
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert("No trolley records to export");
                    return;
                }
                
                exportToPDF(data, "All Trolley Records");
            } catch (error) {
                alert("Error exporting data: " + error.message);
            }
        });
        
        // Export Single Record to PDF
        async function exportSingleRecord(id) {
            try {
                const tableName = currentDataType === 'payment' ? 'admin-singePay' : 'admin-trollysingpay';
                
                const { data, error } = await client
                    .from(tableName)
                    .select('*')
                    .eq('id', id)
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert("Record not found");
                    return;
                }
                
                exportToPDF(data, `${currentDataType.charAt(0).toUpperCase() + currentDataType.slice(1)} Record #${id}`);
            } catch (error) {
                alert("Error exporting record: " + error.message);
            }
        }
        
        // SIMPLE PDF Export Function (Guaranteed to work)
        function exportToPDF(data, title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.setTextColor(40);
            doc.text(title, 14, 22);
            
            // Add date
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Exported on: ${new Date().toLocaleDateString()}`, 14, 30);
            
            // Prepare table data
            const tableData = data.map(item => [
                item.id,
                item.name,
                item.date || '-',
                item.day || '-',
                `${item.paid_amount || 0}`,
                `${item.remain || 0}`,
                `${item.total_amount || 0}`
            ]);
            
            // Calculate total amount
            const totalAmount = data.reduce((sum, item) => sum + (parseInt(item.total_amount) || 0), 0);
            
            // Add table with safe configuration
            try {
                doc.autoTable({
                    head: [['ID', 'Name', 'Date', 'Day', 'Paid Amount', 'Remain', 'Total Amount']],
                    body: tableData,
                    startY: 45,
                    styles: { 
                        fontSize: 10, 
                        cellPadding: 3,
                        overflow: 'linebreak'
                    },
                    headStyles: { 
                        fillColor: [67, 97, 238], 
                        textColor: 255, 
                        fontStyle: 'bold',
                        cellPadding: 4
                    },
                    bodyStyles: {
                        cellPadding: 3
                    },
                    alternateRowStyles: { 
                        fillColor: [240, 240, 240] 
                    },
                    margin: { top: 45 },
                    tableWidth: 'auto'
                });
                
                // Get final Y position safely
                let finalY = 45 + (data.length * 10) + 50; // Default calculation
                
                if (doc.lastAutoTable && doc.lastAutoTable.finalY) {
                    finalY = doc.lastAutoTable.finalY + 15;
                }
                
                // Add total amount at the bottom
                doc.setFontSize(12);
                doc.setTextColor(40);
                doc.setFont(undefined, 'bold');
                doc.text(`TOTAL AMOUNT: ${totalAmount.toLocaleString('en-IN')}`, 14, finalY);
                
            } catch (error) {
                console.error('Error generating PDF table:', error);
                // Fallback: Simple text display if table fails
                doc.setFontSize(12);
                doc.text('Error generating table. Showing data as text:', 14, 45);
                
                let yPos = 60;
                data.forEach((item, index) => {
                    doc.text(`${index + 1}. ID: ${item.id}, Name: ${item.name}, Amount: ‚Çπ${item.total_amount || 0}`, 14, yPos);
                    yPos += 10;
                });
                
                yPos += 10;
                doc.setFont(undefined, 'bold');
                doc.text(`TOTAL AMOUNT: ‚Çπ${totalAmount.toLocaleString('en-IN')}`, 14, yPos);
            }
            
            // Save the PDF with safe filename
            const safeTitle = title.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
            doc.save(`${safeTitle}.pdf`);
        }
        
        // Update Reports Section
        function updateReports(data) {
            // Group data by month
            const monthlyData = {};
            data.forEach(item => {
                if (!item.date) return;
                const date = new Date(item.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthName = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = {
                        month: monthName,
                        total: 0,
                        paid: 0,
                        remain: 0,
                        count: 0
                    };
                }
                
                monthlyData[monthYear].total += item.total_amount || 0;
                monthlyData[monthYear].paid += item.paid_amount || 0;
                monthlyData[monthYear].remain += item.remain || 0;
                monthlyData[monthYear].count += 1;
            });
            
            // Update report table
            const reportBody = document.getElementById('report-body');
            reportBody.innerHTML = '';
            
            let grandTotal = 0;
            let grandPaid = 0;
            let grandRemain = 0;
            let grandCount = 0;
            
            Object.values(monthlyData).forEach(monthData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${monthData.month}</strong></td>
                    <td><strong>${formatIndianCurrency(monthData.total)}</strong></td>
                    <td><strong>${formatIndianCurrency(monthData.paid)}</strong></td>
                    <td><strong>${formatIndianCurrency(monthData.remain)}</strong></td>
                    <td><strong>${monthData.count}</strong></td>
                `;
                reportBody.appendChild(row);
                
                grandTotal += monthData.total;
                grandPaid += monthData.paid;
                grandRemain += monthData.remain;
                grandCount += monthData.count;
            });
            
            // Update grand totals
            document.getElementById('report-grand-total').textContent = formatIndianCurrency(grandTotal);
            document.getElementById('report-grand-paid').textContent = formatIndianCurrency(grandPaid);
            document.getElementById('report-grand-remain').textContent = formatIndianCurrency(grandRemain);
            document.getElementById('report-grand-count').textContent = grandCount;
            
            // Update chart
            updateChart(monthlyData);
        }
        
        // Update Chart
        function updateChart(monthlyData) {
            const ctx = document.getElementById('paymentChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (paymentChart) {
                paymentChart.destroy();
            }
            
            const months = Object.values(monthlyData).map(data => data.month);
            const totals = Object.values(monthlyData).map(data => data.total);
            const paids = Object.values(monthlyData).map(data => data.paid);
            
            paymentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                    {
                        label: 'Total Amount',
                        data: totals,
                        backgroundColor: 'rgba(67, 97, 238, 0.7)',
                        borderColor: 'rgba(67, 97, 238, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Paid Amount',
                        data: paids,
                        backgroundColor: 'rgba(75, 181, 67, 0.7)',
                        borderColor: 'rgba(75, 181, 67, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Monthly Payment Overview'
                        }
                    }
                }
            });
        }
        
        // Generate PDF Report
        document.getElementById('generate-report').addEventListener('click', async function() {
            try {
                const year = document.getElementById('report-year').value;
                const month = document.getElementById('report-month').value;
                const tableName = currentDataType === 'payment' ? 'admin-singePay' : 'admin-trollysingpay';
                
                let query = client
                    .from(tableName)
                    .select('*');
                
                // Filter by year if selected
                if (year !== 'all') {
                    query = query.filter('date', 'like', `${year}-%`);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert(`No ${currentDataType} records found for the selected criteria`);
                    return;
                }
                
                // Filter by month if selected
                let filteredData = data;
                if (month !== 'all') {
                    filteredData = data.filter(item => {
                        if (!item.date) return false;
                        return item.date.startsWith(`${year}-${month}`);
                    });
                }
                
                if (filteredData.length === 0) {
                    alert(`No ${currentDataType} records found for the selected month`);
                    return;
                }
                
                generateYearlyReport(filteredData, year, month);
                
            } catch (error) {
                alert("Error generating report: " + error.message);
            }
        });
        
        // Generate Yearly Report PDF (similar to your example)
        function generateYearlyReport(data, year, month) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.setTextColor(40);
            doc.text(`YEARLY REPORT ${year}`, 14, 22);
            
            // Add export date
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Exported on: ${new Date().toLocaleDateString()}, ${new Date().toLocaleTimeString()}`, 14, 30);
            
            let yPosition = 45;
            
            // Group data by month
            const monthlyData = {};
            data.forEach(item => {
                if (!item.date) return;
                const date = new Date(item.date);
                const monthKey = date.getMonth();
                const monthName = date.toLocaleString('default', { month: 'long' }).toUpperCase();
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        month: monthName,
                        records: [],
                        total: 0
                    };
                }
                
                monthlyData[monthKey].records.push(item);
                monthlyData[monthKey].total += item.total_amount || 0;
            });
            
            // Sort months
            const sortedMonths = Object.keys(monthlyData).sort().map(key => monthlyData[key]);
            
            // Add monthly sections
            sortedMonths.forEach(monthData => {
                // Check if we need a new page
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Add month header
                doc.setFontSize(16);
                doc.setTextColor(40);
                doc.text(`${monthData.month} ${year}`, 14, yPosition);
                yPosition += 10;
                
                // Add table headers
                doc.setFontSize(10);
                doc.setTextColor(100);
                const headers = ['#', 'Date', 'Day', 'Amount', 'Paid', 'Category', 'Status'];
                const colWidths = [10, 30, 30, 25, 20, 35, 25];
                let xPosition = 14;
                
                headers.forEach((header, i) => {
                    doc.text(header, xPosition, yPosition);
                    xPosition += colWidths[i];
                });
                
                yPosition += 6;
                
                // Add horizontal line
                doc.setDrawColor(200);
                doc.line(14, yPosition, 190, yPosition);
                yPosition += 10;
                
                // Add records
                doc.setFontSize(9);
                doc.setTextColor(60);
                
                monthData.records.forEach((record, index) => {
                    // Check if we need a new page
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                        
                        // Add table headers again
                        doc.setFontSize(10);
                        doc.setTextColor(100);
                        xPosition = 14;
                        headers.forEach((header, i) => {
                            doc.text(header, xPosition, yPosition);
                            xPosition += colWidths[i];
                        });
                        
                        yPosition += 6;
                        doc.setDrawColor(200);
                        doc.line(14, yPosition, 190, yPosition);
                        yPosition += 10;
                        doc.setFontSize(9);
                        doc.setTextColor(60);
                    }
                    
                    xPosition = 14;
                    doc.text((index + 1).toString(), xPosition, yPosition);
                    xPosition += colWidths[0];
                    doc.text(record.date || '-', xPosition, yPosition);
                    xPosition += colWidths[1];
                    doc.text(record.day || '-', xPosition, yPosition);
                    xPosition += colWidths[2];
                    doc.text(`‚Çπ${record.total_amount || 0}`, xPosition, yPosition);
                    xPosition += colWidths[3];
                    doc.text(record.paid_amount === record.total_amount ? 'Yes' : 'No', xPosition, yPosition);
                    xPosition += colWidths[4];
                    doc.text('General', xPosition, yPosition); // Placeholder for category
                    xPosition += colWidths[5];
                    doc.text(record.remain === 0 ? 'Closed' : 'Pending', xPosition, yPosition);
                    
                    yPosition += 6;
                });
                
                // Add monthly total
                yPosition += 5;
                doc.setDrawColor(200);
                doc.line(14, yPosition, 190, yPosition);
                yPosition += 8;
                doc.setFontSize(10);
                doc.setTextColor(40);
                doc.text(`TOTAL FOR ${monthData.month}: ${formatIndianCurrency(monthData.total)}`, 14, yPosition);
                yPosition += 15;
                
                // Add page separator
                if (yPosition < 270) {
                    doc.setDrawColor(220);
                    doc.line(14, yPosition, 190, yPosition);
                    yPosition += 10;
                }
            });
            
            // Calculate grand total
            const grandTotal = sortedMonths.reduce((sum, month) => sum + month.total, 0);
            
            // Add grand total on last page
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.setFontSize(12);
            doc.setTextColor(40);
            doc.text(`GRAND TOTAL (${year}): ${formatIndianCurrency(grandTotal)}`, 14, yPosition);
            
            // Save the PDF
            const reportName = month === 'all' ? `YEARLY_REPORT_${year}` : `MONTHLY_REPORT_${year}_${month}`;
            doc.save(`${reportName}.pdf`);
        }
        
        // Show error
        function showError(message) {
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
            errorElement.textContent = message;
        }
        
        // Navigation between sections
        document.querySelectorAll('nav a[data-section]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links
                document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
                
                // Add active class to clicked link
                this.classList.add('active');
                
                // Hide all sections
                document.querySelectorAll('.report-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Show selected section
                const sectionId = this.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
            });
        });
        
        // Switch data type
        function switchDataType(type) {
            currentDataType = type;
            updateUIText();
            fetchPayData();
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateUIText();
            fetchAdminName();
            fetchPayData();
            
            // Set up filter functionality
            document.getElementById('paymentFilterId').addEventListener('input', filterPaymentTable);
            document.getElementById('paymentFilterName').addEventListener('input', filterPaymentTable);
            document.getElementById('paymentFilterDate').addEventListener('input', filterPaymentTable);
            
            document.getElementById('trolleyFilterId').addEventListener('input', filterTrolleyTable);
            document.getElementById('trolleyFilterName').addEventListener('input', filterTrolleyTable);
            document.getElementById('trolleyFilterDate').addEventListener('input', filterTrolleyTable);
            
            // Data type toggle listeners
            paymentToggle.addEventListener('click', () => switchDataType('payment'));
            trolleyToggle.addEventListener('click', () => switchDataType('trolley'));
        });
        
        // Filter payment table
        function filterPaymentTable() {
            const idFilter = document.getElementById('paymentFilterId').value.toLowerCase();
            const nameFilter = document.getElementById('paymentFilterName').value.toLowerCase();
            const dateFilter = document.getElementById('paymentFilterDate').value;
            
            const rows = document.querySelectorAll('#payment-body tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const id = row.cells[0].textContent.toLowerCase();
                const name = row.cells[1].textContent.toLowerCase();
                const date = row.cells[2].textContent;
                
                const idMatch = id.includes(idFilter);
                const nameMatch = name.includes(nameFilter);
                const dateMatch = dateFilter === '' || date === formatDate(dateFilter);
                
                if (idMatch && nameMatch && dateMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.querySelector('.page-info').textContent = `Showing ${visibleCount} entries`;
        }
        
        // Filter trolley table
        function filterTrolleyTable() {
            const idFilter = document.getElementById('trolleyFilterId').value.toLowerCase();
            const nameFilter = document.getElementById('trolleyFilterName').value.toLowerCase();
            const dateFilter = document.getElementById('trolleyFilterDate').value;
            
            const rows = document.querySelectorAll('#trolley-body tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const id = row.cells[0].textContent.toLowerCase();
                const name = row.cells[1].textContent.toLowerCase();
                const date = row.cells[2].textContent;
                
                const idMatch = id.includes(idFilter);
                const nameMatch = name.includes(nameFilter);
                const dateMatch = dateFilter === '' || date === formatDate(dateFilter);
                
                if (idMatch && nameMatch && dateMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.querySelectorAll('.pagination .page-info')[1].textContent = `Showing ${visibleCount} entries`;
        }
        
        // Format date for filtering
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
    </script>
</body>

</html>
