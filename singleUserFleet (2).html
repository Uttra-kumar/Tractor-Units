<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tractor Fleet Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All CSS remains the same as previous version */
        :root {
            --primary: #1a6fc4;
            --primary-light: #4a9be8;
            --primary-dark: #0d5aa7;
            --secondary: #2c3e50;
            --secondary-light: #3c5168;
            --accent: #FF8200;
            --accent-light: #ffa347;
            --success: #1abc9c;
            --success-light: #2fe2bf;
            --danger: #e74c3c;
            --danger-light: #ff6b5b;
            --warning: #f39c12;
            --warning-light: #ffb74d;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f7ff 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            flex: 1;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.8rem 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
            transform: rotate(30deg);
        }
        
        .website-name {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .website-name i {
            font-size: 2.8rem;
            color: var(--accent);
        }
        
        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            font-weight: 500;
        }
        
        nav {
            background-color: var(--secondary);
            padding: 0.8rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        nav ul {
            display: flex;
            justify-content: center;
            list-style: none;
        }
        
        nav ul li {
            margin: 0 15px;
        }
        
        .delete-btn {
            padding: 6px 12px;
            font-size: 0.9rem;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: white;
            border: none;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 10px 18px;
            border-radius: 8px;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        nav ul li a::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        nav ul li a:hover {
            background-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(26, 111, 196, 0.4);
        }
        
        nav ul li a:hover::before {
            left: 100%;
        }
        
        .content {
            padding: 30px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .page-title {
            font-size: 2rem;
            color: var(--secondary);
            font-weight: 700;
            position: relative;
            padding-bottom: 10px;
        }
        
        .page-title::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 2px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(26, 111, 196, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #16a085);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(26, 188, 156, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #e67e22);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(243, 156, 18, 0.3);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3);
        }
        
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border-top: 5px solid var(--primary);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .card h3 i {
            color: var(--primary);
            font-size: 1.3rem;
        }
        
        .card-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .card-desc {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 40px;
            border: 1px solid var(--gray-light);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: white;
            font-weight: 600;
            padding: 18px 15px;
            text-align: left;
            position: relative;
        }
        
        th::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f0f8ff;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--gray);
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .error {
            color: var(--danger);
            text-align: center;
            padding: 25px;
            font-size: 1.2rem;
            background-color: #ffecec;
            border-radius: var(--border-radius);
            margin: 20px 0;
            border: 1px solid #ffcdd2;
            box-shadow: var(--shadow);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: modalAppear 0.3s ease-out;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background: #f9f9f9;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 111, 196, 0.1);
            background: white;
        }
        
        .user-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--gray-light);
        }
        
        .info-row {
            display: flex;
            margin-bottom: 18px;
            padding-bottom: 18px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .info-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: var(--secondary);
            width: 180px;
        }
        
        .info-value {
            color: var(--dark);
            flex: 1;
            font-weight: 500;
        }
        
        .modal-footer {
            padding: 25px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        footer {
            background: var(--secondary);
            color: white;
            padding: 1.8rem 0;
            margin-top: auto;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }
        
        footer p {
            color: #ecf0f1;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        footer span {
            color: var(--accent);
            font-weight: 700;
        }
        
        .session-info {
            display: inline-block;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.7rem 1.2rem;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        #counter {
            display: inline-block;
            padding: 0.3rem 0.9rem;
            border-radius: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            animation: pulse 2s infinite;
            margin-left: 0.5rem;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
            
            50% {
                box-shadow: 0 4px 20px rgba(255, 107, 107, 0.7);
            }
            
            100% {
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
        }
        
        .status-badge {
            display: inline-block;
            padding: 7px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-active {
            background: #e8f6f3;
            color: var(--success);
            border: 1px solid #a3e4d7;
        }
        
        .status-inactive {
            background: #fdedec;
            color: var(--danger);
            border: 1px solid #f5b7b1;
        }
        
        .sms-preview {
            background: #f0f8ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            border: 1px dashed #3498db;
        }
        
        .sms-preview h4 {
            color: var(--secondary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sms-content {
            background: white;
            padding: 18px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            border: 1px solid #eaeaea;
            line-height: 1.5;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .history-item {
            background: white;
            font-weight: bold;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .history-date {
            font-weight: 600;
            color: var(--secondary);
        }
        
        .history-phone {
            color: var(--gray);
        }
        
        .history-message {
            font-size: 0.9rem;
            color: var(--dark);
            white-space: pre-wrap;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 1.5rem;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .checkbox-group input {
            width: auto;
        }
        
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: space-between;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            nav ul {
                flex-direction: column;
                align-items: center;
            }
            
            nav ul li {
                margin: 8px 0;
            }
            
            .info-row {
                flex-direction: column;
            }
            
            .info-label {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .modal-content {
                width: 95%;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .history-header {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="website-name">
                <i class="fas fa-tractor"></i> Tractor Fleet Management
            </div>
            <div class="header-subtitle">Single User Dashboard</div>
        </header>
        
        <nav>
            <ul>
                <li><a href="admin-alluser.html" ><i class="fas fa-arrow-left"></i> Back</a></li>
                <li><a href="admin-dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#"><i class="fas fa-chart-bar"></i> Reports</a></li>
                <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </nav>
        
        <div class="content">
            <div class="dashboard-header">
                <h1 class="page-title">User Fleet Details</h1>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="getDataBtn">
                        <i class="fas fa-download"></i> Get Data
                    </button>
                    <button class="btn btn-success" id="exportBtn">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                    <button class="btn btn-info" id="smsHistoryBtn">
                        <i class="fas fa-history"></i> SMS History
                    </button>
                    <button class="btn btn-warning" id="managePhoneBtn">
                        <i class="fas fa-phone"></i> Manage Phone
                    </button>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="fleet-data">Fleet Data</div>
                <div class="tab" data-tab="sms-history">SMS History</div>
            </div>
            
            <div class="tab-content active" id="fleet-data">
                <div class="cards-container">
                    <div class="card">
                        <h3><i class="fas fa-user"></i> User ID</h3>
                        <div class="card-value" id="userIdCard">-</div>
                        <div class="card-desc">Current user identifier</div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-user-tag"></i> User Name</h3>
                        <div class="card-value" id="userNameCard">-</div>
                        <div class="card-desc">Name of the fleet user</div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-phone"></i> Phone Number</h3>
                        <div class="card-value" id="phoneCard">-</div>
                        <div class="card-desc">User's contact number</div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-clock"></i> Total Running Time</h3>
                        <div class="card-value" id="totalTimeCard">0 min</div>
                        <div class="card-desc">Cumulative operational time</div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-calendar-alt"></i> Data Entries</h3>
                        <div class="card-value" id="entriesCard">0</div>
                        <div class="card-desc">Number of records</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="fleet-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User ID</th>
                                <th>Name</th>
                                <th>Date</th>
                                <th>Day</th>
                                <th id="runningTimeHeader">Running Time (Minutes)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="loading" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading fleet data...
                </div>
                <div id="error" class="error" style="display: none;"></div>
            </div>
            
            <div class="tab-content" id="sms-history">
                <div class="table-container">
                    <div id="sms-history-list">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading SMS history...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Data Modal -->
    <div class="modal" id="userDataModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-user-circle"></i> User Fleet Summary</h2>
                <button class="close-modal" id="closeUserModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="user-info">
                    <div class="info-row">
                        <div class="info-label">User ID:</div>
                        <div class="info-value" id="modalUserId">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Name:</div>
                        <div class="info-value" id="modalUserName">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Phone Number:</div>
                        <div class="info-value" id="modalPhone">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label" id="modalTimeLabel">Total Running Time:</div>
                        <div class="info-value" id="modalTotalTime">0 minutes</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Data Entries:</div>
                        <div class="info-value" id="modalEntries">0</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Last Updated:</div>
                        <div class="info-value" id="modalLastUpdate">-</div>
                    </div>
                </div>
                
                <div class="sms-preview">
                    <h4><i class="fas fa-sms"></i> SMS Preview</h4>
                    <div class="sms-content" id="smsPreview">
                        Fleet Summary for [User Name]:
                        User ID: [User ID]
                        Total Running Time: [Time] minutes
                        Data Entries: [Count]
                        Last Updated: [Date]
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" id="editBtn">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-success" id="sendSmsBtn">
                    <i class="fas fa-paper-plane"></i> Send SMS
                </button>
            </div>
        </div>
    </div>
    
    <!-- SMS Modal -->
    <div class="modal" id="smsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-sms"></i> Send SMS</h2>
                <button class="close-modal" id="closeSmsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="phoneNumber"><i class="fas fa-phone"></i> Phone Number</label>
                    <input type="tel" id="phoneNumber" placeholder="Enter phone number with country code">
                    <button type="button" class="btn btn-info" id="useSavedPhone" style="margin-top: 8px; padding: 8px 12px;">
                        <i class="fas fa-download"></i> Use Saved Number
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="smsType"><i class="fas fa-list"></i> SMS Type</label>
                    <select id="smsType">
                        <option value="all">Send All Data</option>
                        <option value="unsent">Send Only Unsent Data</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="smsMessage"><i class="fas fa-envelope"></i> Message</label>
                    <textarea id="smsMessage" rows="6" placeholder="SMS message will be auto-filled"></textarea>
                </div>
                
                <div class="sms-preview">
                    <h4><i class="fas fa-eye"></i> Preview</h4>
                    <div class="sms-content" id="finalSmsPreview">
                        Your SMS preview will appear here
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelSmsBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-success" id="confirmSendSmsBtn">
                    <i class="fas fa-paper-plane"></i> Send via SMS App
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Edit User Data</h2>
                <button class="close-modal" id="closeEditModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editUserName"><i class="fas fa-user"></i> User Name</label>
                    <input type="text" id="editUserName" placeholder="Enter user name">
                </div>
                
                <div class="form-group">
                    <label for="editRunningTime" id="editRunningTimeLabel"><i class="fas fa-clock"></i> Total Running Time (minutes)</label>
                    <input type="number" id="editRunningTime" placeholder="Enter total running time">
                </div>
                
                <div class="form-group">
                    <label for="editEntries"><i class="fas fa-list"></i> Data Entries</label>
                    <input type="number" id="editEntries" placeholder="Enter number of entries">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelEditBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-success" id="saveEditBtn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Phone Management Modal -->
    <div class="modal" id="phoneModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-phone"></i> Manage Phone Number</h2>
                <button class="close-modal" id="closePhoneModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editPhoneNumber"><i class="fas fa-mobile-alt"></i> Phone Number</label>
                    <input type="tel" id="editPhoneNumber" placeholder="Enter phone number with country code">
                </div>
                
                <div class="user-info">
                    <div class="info-row">
                        <div class="info-label">Current User:</div>
                        <div class="info-value" id="phoneModalUserName">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">User ID:</div>
                        <div class="info-value" id="phoneModalUserId">-</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Current Phone:</div>
                        <div class="info-value" id="currentPhoneValue">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelPhoneBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-success" id="savePhoneBtn">
                    <i class="fas fa-save"></i> Save Phone Number
                </button>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Tractor Fleet Management || Designed By <span>Uttra Patel</span></p>
            <div class="session-info">
                Session expires in <span id="counter">0s</span>
            </div>
        </div>
    </footer>
        <script src="session.js"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://iydamvrlxtwsnqvflaxq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZGFtdnJseHR3c25xdmZsYXhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTczMTIsImV4cCI6MjA3MzY3MzMxMn0.Z8m6XGyu9wsN_UJ8EZYr12BRemsO12_U8EEZ9JizQ6w';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Get ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const user_id = urlParams.get('id');

        // Determine table name and column based on ID length
        let tableName = '';
        let runningTimeColumn = 'running_time';
        let dataType = '';
        let userTableName = ''; // Table name for user registration data

        if (user_id) {
            if (user_id.length === 6) {
                tableName = 'admin-fleet';
                runningTimeColumn = 'running_time';
                dataType = 'Fleet';
                userTableName = 'userRegistration-T'; // Table for fleet users
            } else if (user_id.length === 4) {
                tableName = 'admin-trolly';
                runningTimeColumn = 'trolley';
                dataType = 'Trolley';
                userTableName = 'userReg_T'; // Table for trolley users
            }
        }
        
        // DOM elements
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        const fleetTable = document.getElementById('fleet-table');
        const tableBody = document.getElementById('table-body');
        const getDataBtn = document.getElementById('getDataBtn');
        const userDataModal = document.getElementById('userDataModal');
        const closeUserModal = document.getElementById('closeUserModal');
        const sendSmsBtn = document.getElementById('sendSmsBtn');
        const editBtn = document.getElementById('editBtn');
        const smsHistoryBtn = document.getElementById('smsHistoryBtn');
        const managePhoneBtn = document.getElementById('managePhoneBtn');
        
        // SMS Modal elements
        const smsModal = document.getElementById('smsModal');
        const closeSmsModal = document.getElementById('closeSmsModal');
        const phoneNumber = document.getElementById('phoneNumber');
        const useSavedPhone = document.getElementById('useSavedPhone');
        const smsType = document.getElementById('smsType');
        const smsMessage = document.getElementById('smsMessage');
        const finalSmsPreview = document.getElementById('finalSmsPreview');
        const cancelSmsBtn = document.getElementById('cancelSmsBtn');
        const confirmSendSmsBtn = document.getElementById('confirmSendSmsBtn');
        
        // Edit Modal elements
        const editModal = document.getElementById('editModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const editUserName = document.getElementById('editUserName');
        const editRunningTime = document.getElementById('editRunningTime');
        const editEntries = document.getElementById('editEntries');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveEditBtn = document.getElementById('saveEditBtn');
        
        // Phone Modal elements
        const phoneModal = document.getElementById('phoneModal');
        const closePhoneModal = document.getElementById('closePhoneModal');
        const editPhoneNumber = document.getElementById('editPhoneNumber');
        const phoneModalUserName = document.getElementById('phoneModalUserName');
        const phoneModalUserId = document.getElementById('phoneModalUserId');
        const currentPhoneValue = document.getElementById('currentPhoneValue');
        const cancelPhoneBtn = document.getElementById('cancelPhoneBtn');
        const savePhoneBtn = document.getElementById('savePhoneBtn');
        
        // Card elements
        const userIdCard = document.getElementById('userIdCard');
        const userNameCard = document.getElementById('userNameCard');
        const phoneCard = document.getElementById('phoneCard');
        const totalTimeCard = document.getElementById('totalTimeCard');
        const entriesCard = document.getElementById('entriesCard');
        
        // Modal elements
        const modalUserId = document.getElementById('modalUserId');
        const modalUserName = document.getElementById('modalUserName');
        const modalPhone = document.getElementById('modalPhone');
        const modalTotalTime = document.getElementById('modalTotalTime');
        const modalEntries = document.getElementById('modalEntries');
        const modalLastUpdate = document.getElementById('modalLastUpdate');
        const smsPreview = document.getElementById('smsPreview');
        
        // Tab elements
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // SMS History elements
        const smsHistoryList = document.getElementById('sms-history-list');

        // Table header element
        const runningTimeHeader = document.getElementById('runningTimeHeader');
        const modalTimeLabel = document.getElementById('modalTimeLabel');
        const editRunningTimeLabel = document.getElementById('editRunningTimeLabel');
        
        let fleetData = [];
        let userName = '';
        let userPhone = '';
        let totalRunningTime = 0;
        let entriesCount = 0;
        let sentEntries = new Set(); // Track which entries have been sent
        let currentSentEntries = []; // Track entries being sent in current SMS
        
        // Update UI based on data type
        function updateUIForDataType() {
            if (dataType === 'Trolley') {
                runningTimeHeader.textContent = 'Trolley Count';
                modalTimeLabel.textContent = 'Total Trolley Count:';
                editRunningTimeLabel.innerHTML = '<i class="fas fa-clock"></i> Total Trolley Count';
            } else {
                runningTimeHeader.textContent = 'Running Time (Minutes)';
                modalTimeLabel.textContent = 'Total Running Time:';
                editRunningTimeLabel.innerHTML = '<i class="fas fa-clock"></i> Total Running Time (minutes)';
            }
        }
        
        // Fetch user phone number from registration tables based on ID length
        async function fetchUserPhone() {
            if (!userTableName) {
                console.error('User table name not determined');
                userPhone = '';
                phoneCard.textContent = 'Not set';
                return '';
            }
            
            try {
                let mobileColumn = 'mobile'; // Default column name
                
                // Fetch user data from the appropriate registration table
                const { data, error } = await supabase
                    .from(userTableName)
                    .select('*')
                    .eq('user_id', user_id)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') { // Not found error
                        console.log('User not found in registration table');
                        userPhone = '';
                        phoneCard.textContent = 'Not set';
                        return '';
                    }
                    throw error;
                }
                
                // Extract mobile number based on table structure
                if (data) {
                    // Try different possible column names for mobile number
                    userPhone = data.mobile || data.mobile_no || data.phone || data.phone_number || '';
                    
                    if (userPhone) {
                        console.log(`Found phone number: ${userPhone} from table ${userTableName}`);
                    } else {
                        console.log('No mobile number found in user data');
                    }
                } else {
                    userPhone = '';
                }
                
                phoneCard.textContent = userPhone || 'Not set';
                return userPhone;
                
            } catch (error) {
                console.error('Error fetching phone number from registration table:', error);
                userPhone = '';
                phoneCard.textContent = 'Error loading';
                return '';
            }
        }
        
        // Save user phone number to database (backup in user_phones table)
        async function saveUserPhone(phone) {
            try {
                // First check if user already exists in user_phones table
                const { data: existingData, error: checkError } = await supabase
                    .from('user_phones')
                    .select('id')
                    .eq('user_id', user_id)
                    .single();
                
                let result;
                
                if (checkError && checkError.code === 'PGRST116') {
                    // User doesn't exist, insert new record
                    result = await supabase
                        .from('user_phones')
                        .insert([
                            {
                                user_id: user_id,
                                user_name: userName,
                                phone_number: phone
                            }
                        ]);
                } else {
                    // User exists, update record
                    result = await supabase
                        .from('user_phones')
                        .update({ 
                            phone_number: phone,
                            user_name: userName 
                        })
                        .eq('user_id', user_id);
                }
                
                if (result.error) {
                    throw result.error;
                }
                
                userPhone = phone;
                phoneCard.textContent = userPhone;
                return true;
            } catch (error) {
                console.error('Error saving phone number:', error);
                return false;
            }
        }
        
        // Fetch fleet data from Supabase
        async function fetchFleetData() {
            if (!user_id) {
                showError('No user ID provided in URL');
                return;
            }

            if (!tableName) {
                showError('Invalid user ID format. Must be 4 or 6 digits.');
                return;
            }
            
            try {
                // Update UI based on data type
                updateUIForDataType();
                
                // Fetch data from Supabase
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*')
                    .eq('user_id', user_id);
                
                if (error) {
                    throw error;
                }
                
                fleetData = data || [];
                
                // Calculate user name (assuming first entry has the name)
                if (fleetData.length > 0) {
                    userName = fleetData[0].name || 'Unknown';
                }
                
                // Calculate total running time/trolley count
                totalRunningTime = fleetData.reduce((total, item) => {
                    const value = parseInt(item[runningTimeColumn]) || 0;
                    return total + value;
                }, 0);
                
                entriesCount = fleetData.length;
                
                // Fetch user phone number from registration tables
                await fetchUserPhone();
                
                // Update cards
                updateCards();
                
                // Display data in table
                displayData(fleetData);
                
                // Load SMS history to determine sent entries
                await loadSmsHistory();
                
            } catch (error) {
                showError('Error fetching data: ' + error.message);
            }
        }
        
        // Load SMS history
        async function loadSmsHistory() {
            try {
                const { data, error } = await supabase
                    .from('sms_history')
                    .select('*')
                    .eq('user_id', user_id)
                    .order('sent_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                displaySmsHistory(data || []);
                
                // Update sent entries set
                updateSentEntries(data || []);
                
            } catch (error) {
                console.error('Error loading SMS history:', error);
                smsHistoryList.innerHTML = `<div class="error">Error loading SMS history: ${error.message}</div>`;
            }
        }
        
        // Update sent entries set based on SMS history
        function updateSentEntries(smsHistory) {
            sentEntries.clear();
            
            smsHistory.forEach(record => {
                if (record.sent_entries && Array.isArray(record.sent_entries)) {
                    record.sent_entries.forEach(id => {
                        sentEntries.add(id.toString());
                    });
                }
            });
        }
        
        // Display SMS history with delete button
        function displaySmsHistory(history) {
            if (history.length === 0) {
                smsHistoryList.innerHTML = '<div class="loading">No SMS history found for this user.</div>';
                return;
            }

            let html = '';
            history.forEach(record => {
                const sentAt = new Date(record.sent_at).toLocaleString();
                html += `
                    <div class="history-item" id="sms-${record.id}">
                        <div class="history-header">
                            <div class="history-date">${sentAt}</div>
                            <div class="history-phone">
                                ${record.user_name} - ${record.phone_number}
                                
                            </div>
                        </div>
                        <div class="history-message">${record.message}</div>
                        <button class="btn btn-danger delete-btn" onclick="deleteSmsHistory(${record.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                    </div>
                `;
            });

            smsHistoryList.innerHTML = html; 
        }

        // Delete SMS history record
        async function deleteSmsHistory(id) {
            const confirmDelete = confirm("Are you sure you want to delete this SMS history?");
            if (!confirmDelete) return;

            try {
                const { error } = await supabase
                    .from('sms_history')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                // Remove the deleted item from DOM
                const item = document.getElementById(`sms-${id}`);
                if (item) item.remove();

                alert("SMS history deleted successfully!");
            } catch (err) {
                console.error("Error deleting SMS history:", err);
                alert("Error deleting SMS history: " + err.message);
            }
        }
        
        // Update dashboard cards
        function updateCards() {
            userIdCard.textContent = user_id || '-';
            userNameCard.textContent = userName || '-';
            phoneCard.textContent = userPhone || 'Not set';
            
            if (dataType === 'Trolley') {
                totalTimeCard.textContent = `${totalRunningTime} trolleys`;
            } else {
                totalTimeCard.textContent = `${totalRunningTime} min`;
            }
            
            entriesCard.textContent = entriesCount;
        }
        
        // Display data in table
        function displayData(data) {
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" style="text-align: center;">No data available for this user</td>`;
                tableBody.appendChild(row);
            } else {
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Determine status based on running time/trolley count
                    const timeValue = parseInt(item[runningTimeColumn]) || 0;
                    const status = timeValue > 0 ?
                        '<span class="status-badge status-active">Active</span>' :
                        '<span class="status-badge status-inactive">Inactive</span>';
                    
                    // Add sent indicator
                    const sentIndicator = sentEntries.has(item.id.toString()) ? 
                        '<i class="fas fa-check-circle" style="color: var(--success); margin-left: 5px;" title="Already sent"></i>' : '';
                    
                    row.innerHTML = `
                        <td>${item.id}${sentIndicator}</td>
                        <td>${item.user_id}</td>
                        <td>${item.name || 'N/A'}</td>
                        <td>${formatDate(item.date)}</td>
                        <td>${getDayOfWeek(item.date)}</td>
                        <td>${timeValue}</td>
                        <td>${status}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
            
            loadingElement.style.display = 'none';
            fleetTable.style.display = 'table';
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Get day of week
        function getDayOfWeek(dateString) {
            if (!dateString) return 'N/A';
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const date = new Date(dateString);
            return days[date.getDay()];
        }
        
        // Show error
        function showError(message) {
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
            errorElement.textContent = message;
        }
        
        // Open user data modal
        function openUserDataModal() {
            // Update modal content
            modalUserId.textContent = user_id || '-';
            modalUserName.textContent = userName || '-';
            modalPhone.textContent = userPhone || 'Not set';
            
            if (dataType === 'Trolley') {
                modalTotalTime.textContent = `${totalRunningTime} trolleys`;
            } else {
                modalTotalTime.textContent = `${totalRunningTime} minutes`;
            }
            
            modalEntries.textContent = entriesCount;
            modalLastUpdate.textContent = new Date().toLocaleString();
            
            // Update SMS preview
            if (dataType === 'Trolley') {
                smsPreview.textContent = `Fleet Summary for ${userName}:
User ID: ${user_id}
Phone: ${userPhone || 'Not set'}
Total Trolley Count: ${totalRunningTime}
Data Entries: ${entriesCount}
Last Updated: ${new Date().toLocaleString()}`;
            } else {
                smsPreview.textContent = `Fleet Summary for ${userName}:
User ID: ${user_id}
Phone: ${userPhone || 'Not set'}
Total Running Time: ${totalRunningTime} minutes
Data Entries: ${entriesCount}
Last Updated: ${new Date().toLocaleString()}`;
            }
            
            // Show modal
            userDataModal.style.display = 'flex';
        }
        
        // Close user modal
        function closeUserDataModal() {
            userDataModal.style.display = 'none';
        }
        
        // Open SMS modal
        function openSmsModal() {
            if (!fleetData || fleetData.length === 0) {
                alert("No data available to send SMS!");
                return;
            }
            
            // Reset SMS type to default
            smsType.value = 'all';
            
            // Generate SMS message based on selected type
            generateSmsMessage();
            
            // Show modal
            smsModal.style.display = 'flex';
        }
        
        // Generate SMS message based on selected type
        function generateSmsMessage() {
            const type = smsType.value;
            let message = '';
            currentSentEntries = [];
            
            if (type === 'all') {
                // Create entry-wise breakup text for all data
                let breakup = '';
                fleetData.forEach((item, index) => {
                    const date = new Date(item.date).toLocaleDateString('en-IN');
                    const value = parseInt(item[runningTimeColumn]) || 0;
                    
                    if (dataType === 'Trolley') {
                        breakup += `${index + 1}  ${date} - ${value}  \n`;
                    } else {
                        breakup += `${index + 1}  ${date} - ${value}  \n`;
                    }
                    
                    currentSentEntries.push(item.id.toString());
                });
                
                if (dataType === 'Trolley') {
                    message = `Trolley Summary for ${userName}:
--------------------------------
${breakup}--------------------------------
 : ${totalRunningTime}
----------------------------------------
Last Updated: ${new Date().toLocaleString()}
`;
                } else {
                    message = `Fleet Summary for ${userName}:
--------------------------------
${breakup}--------------------------------
 : ${totalRunningTime}  
----------------------------------------
Last Updated: ${new Date().toLocaleString()}
`;
                }
            } else {
                // Create entry-wise breakup text for unsent data only
                let breakup = '';
                let unsentCount = 0;
                let unsentTotalValue = 0;
                
                fleetData.forEach((item, index) => {
                    if (!sentEntries.has(item.id.toString())) {
                        const date = new Date(item.date).toLocaleDateString('en-IN');
                        const value = parseInt(item[runningTimeColumn]) || 0;
                        
                        if (dataType === 'Trolley') {
                            breakup += `${unsentCount + 1}  ${date} - ${value}  \n`;
                        } else {
                            breakup += `${unsentCount + 1}  ${date} - ${value}  \n`;
                        }
                        
                        unsentTotalValue += value;
                        unsentCount++;
                        currentSentEntries.push(item.id.toString());
                    }
                });
                
                if (unsentCount === 0) {
                    message = `No new data to send for ${userName}.
All data has already been sent previously.`;
                    currentSentEntries = [];
                } else {
                    if (dataType === 'Trolley') {
                        message = `New Remain Trolley Data for ${userName}:
--------------------------------
${breakup}--------------------------------
 : ${unsentTotalValue}
----------------------------------------
Last Updated: ${new Date().toLocaleString()}
`;
                    } else {
                        message = `New Remain Fleet Data for ${userName}:
--------------------------------
${breakup}--------------------------------
  : ${unsentTotalValue}  
----------------------------------------
Last Updated: ${new Date().toLocaleString()}
`;
                    }
                }
            }
            
            // Fill fields
            smsMessage.value = message;
            finalSmsPreview.textContent = message;
        }
        
        // Close SMS modal
        function closeSMSModal() {
            smsModal.style.display = 'none';
        }
        
        // Use saved phone number
        function useSavedPhoneNumber() {
            if (userPhone) {
                phoneNumber.value = userPhone;
            } else {
                alert("No saved phone number found for this user.");
            }
        }
        
        // Send SMS function - opens default SMS app and stores history
        async function sendSMS() {
            const phone = phoneNumber.value.trim();
            const message = smsMessage.value;
            
            if (!phone) {
                alert("Please enter a phone number");
                return;
            }
            
            if (message.includes("No new data to send")) {
                alert("No new data to send. All data has already been sent previously.");
                closeSMSModal();
                return;
            }
            
            if (currentSentEntries.length === 0) {
                alert("No data selected to send.");
                return;
            }
            
            try {
                // Prepare data for insertion
                const smsData = {
                    user_id: user_id,
                    user_name: userName || 'Unknown',
                    phone_number: phone,
                    message: message,
                    sent_entries: currentSentEntries,
                    sent_at: new Date().toISOString()
                };
                
                // Store SMS history in Supabase
                const { data, error } = await supabase
                    .from('sms_history')
                    .insert([smsData]);
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                // Update sent entries set
                currentSentEntries.forEach(id => {
                    sentEntries.add(id);
                });
                
                // Refresh the table to show sent indicators
                displayData(fleetData);
                
                // Create SMS URL scheme
                const smsUrl = `sms:${phone}?body=${encodeURIComponent(message)}`;
                
                // Open SMS app
                window.location.href = smsUrl;
                
                // Close modal
                closeSMSModal();
                
            } catch (error) {
                console.error("Error storing SMS history:", error);
                alert("Error storing SMS history: " + error.message);
            }
        }
        
        // Open Edit modal
        function openEditModal() {
            // Fill form with current data
            editUserName.value = userName || '';
            editRunningTime.value = totalRunningTime || 0;
            editEntries.value = entriesCount || 0;
            
            // Show modal
            editModal.style.display = 'flex';
        }
        
        // Close Edit modal
        function closeEDITModal() {
            editModal.style.display = 'none';
        }
        
        // Save edited data
        function saveEditedData() {
            // Update local variables
            userName = editUserName.value;
            totalRunningTime = parseInt(editRunningTime.value) || 0;
            entriesCount = parseInt(editEntries.value) || 0;
            
            // Update cards
            updateCards();
            
            // Close modal
            closeEDITModal();
            
            // Show success message
            alert("Data updated successfully!");
        }
        
        // Open Phone Management modal
        function openPhoneModal() {
            // Fill form with current data
            editPhoneNumber.value = userPhone || '';
            phoneModalUserName.textContent = userName || '-';
            phoneModalUserId.textContent = user_id || '-';
            currentPhoneValue.textContent = userPhone || 'Not set';
            
            // Show modal
            phoneModal.style.display = 'flex';
        }
        
        // Close Phone modal
        function closePhoneModalC() {
            phoneModal.style.display = 'none';
        }
        
        // Save phone number
        async function savePhoneNumber() {
            const phone = editPhoneNumber.value.trim();
            
            if (!phone) {
                alert("Please enter a phone number");
                return;
            }
            
            const success = await saveUserPhone(phone);
            
            if (success) {
                alert("Phone number saved successfully!");
                closePhoneModalC();
            } else {
                alert("Error saving phone number. Please try again.");
            }
        }
        
        // Tab switching functionality
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show corresponding content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabId) {
                        content.classList.add('active');
                    }
                });
                
                // Load SMS history if that tab is selected
                if (tabId === 'sms-history') {
                    loadSmsHistory();
                }
            });
        });
        
        // Event listeners
        getDataBtn.addEventListener('click', openUserDataModal);
        closeUserModal.addEventListener('click', closeUserDataModal);
        sendSmsBtn.addEventListener('click', openSmsModal);
        editBtn.addEventListener('click', openEditModal);
        smsHistoryBtn.addEventListener('click', () => {
            tabs[1].click(); // Switch to SMS History tab
        });
        managePhoneBtn.addEventListener('click', openPhoneModal);
        
        // SMS Modal events
        closeSmsModal.addEventListener('click', closeSMSModal);
        cancelSmsBtn.addEventListener('click', closeSMSModal);
        confirmSendSmsBtn.addEventListener('click', sendSMS);
        smsType.addEventListener('change', generateSmsMessage);
        useSavedPhone.addEventListener('click', useSavedPhoneNumber);
        
        // Edit Modal events
        closeEditModal.addEventListener('click', closeEDITModal);
        cancelEditBtn.addEventListener('click', closeEDITModal);
        saveEditBtn.addEventListener('click', saveEditedData);
        
        // Phone Modal events
        closePhoneModal.addEventListener('click', closePhoneModalC);
        cancelPhoneBtn.addEventListener('click', closePhoneModalC);
        savePhoneBtn.addEventListener('click', savePhoneNumber);
        
        // Update SMS preview when message changes
        smsMessage.addEventListener('input', function() {
            finalSmsPreview.textContent = this.value;
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === userDataModal) {
                closeUserDataModal();
            }
            if (e.target === smsModal) {
                closeSMSModal();
            }
            if (e.target === editModal) {
                closeEDITModal();
            }
            if (e.target === phoneModal) {
                closePhoneModalC();
            }
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', fetchFleetData);
    </script>
</body>

</html>