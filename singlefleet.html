<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tractor Fleet Management</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f8ff;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1a6fc4, #2c3e50);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        
        
        p {
            line-height: 1rem;
            color: #34495e;
            margin-bottom: 1rem;
        }
        
        footer {
            background: #2c3e50;
            color: white;
            padding: 1.5rem 0;
            margin-top: 30px;
        }
        
        .contain {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }
        
        footer p {
            color: #ecf0f1;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        
        footer span {
            color: #FF8200;
            font-weight: 600;
        }
        
        /* Session counter specific styling */
        #counter {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            animation: pulse 2s infinite;
            margin-left: 0.25rem;
        }
        
        p1 {
            font-size: 1.2rem;
            color: #ecf0f1 !important;
            display: inline-block;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }
        
        .website-name {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        nav {
            background-color: #34495e;
            padding: 0.8rem;
        }
        
        nav ul {
            display: flex;
            justify-content: center;
            list-style: none;
        }
        
        nav ul li {
            margin: 0 15px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-weight: 500;
        }
        
        nav ul li a:hover {
            background-color: #1a6fc4;
        }
        
        .content {
            padding: 20px;
        }
        
        .cards-container {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .card {
            flex: 1;
            min-width: 250px;
            background: linear-gradient(135deg, #3498db, #1a6fc4);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .card h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .calculator {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
            
        }
        
        .calculator h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .calculator-form {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
            border-radius: 5px;
            font-weight: bold;
            
        }
        
        .btn-delete:hover {
            background-color: #c0392b;
        }
        
        .btn-edit {
            background-color: #1abc9c;
            color: white;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .btn-edit:hover {
            background-color: #16a085;
        }
        
        .btn-cancel {
            background-color: var(--gray);
        }
        
        .btn-cancel:hover {
            background-color: #7f8c8d;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .calculator-result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            font-size: 1.2rem;
            color: #2c3e50;
            border: 1px dashed #3498db;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }
        
        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f0f8ff;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }
        
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            background-color: #ffecec;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffcdd2;
        }
        
        .currency {
            font-family: Arial, sans-serif;
        }
        
        @media (max-width: 768px) {
            nav ul {
                flex-direction: column;
                align-items: center;
            }
            
            nav ul li {
                margin: 5px 0;
            }
            
            .cards-container {
                flex-direction: column;
            }
            
            .calculator-form {
                flex-direction: column;
            }
            
            th,
            td {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="website-name">Tractor Fleet Management For Single User</div>
        </header>
        
        <nav>
            <ul>
                <li><a href="admin-alluser.html" onclick="history.back()">Back</a></li>
                <li><a href="admin-dashboard.html">Dashboard</a></li>
                <li><a href="#">Reports</a></li>
                <li><a href="#">Settings</a></li>
            </ul>
        </nav>
        
        <div class="content">
            <div class="cards-container">
                <div class="card">
                    <h3>Total Running Time</h3>
                    <div id="total-running-time" class="card-value">0 Minutes</div>
                </div>
                <div class="card">
                    <h3>Total Amount</h3>
                    <div id="total-amount" class="card-value">₹0</div>
                </div>
            </div>
            
            <div class="calculator">
                <h3>Payment Calculator (Indian Currency)</h3>
                <div class="calculator-form">
                    <div class="form-group">
                        <label for="total-amount-input">Total Amount (₹)</label>
                        <input type="number" id="total-amount-input" readonly>
                    </div>
                    <div class="form-group">
                        <label for="paid-amount">Paid Amount (₹)</label>
                        <input type="number" id="paid-amount" placeholder="Enter paid amount">
                    </div>
                </div>
                <div id="calculator-result" class="calculator-result">Remaining amount: ₹0</div>
            </div>
            
            <div id="loading" class="loading">Loading fleet data...</div>
            <div id="error" class="error" style="display: none;"></div>
            
            <div class="table-container">
                <table id="fleet-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Day</th>
                            <th>Running Time (Minutes)</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            
            <!-- ✅ Payment Form -->
            <div class="calculator" style="margin-top: 25px;">
                <h3>Add Payment Record</h3>
                <form id="payment-form" class="calculator-form">
                    <div class="form-group">
                        <label for="payment-id"> ID</label>
                        <input type="number" id="payment-id" required>
                    </div>
                      <div class="form-group">
                        <label for="payment-id">User ID</label>
                        <input type="number" id="payment-id2" required>
                    </div>
                    <div class="form-group">
                        <label for="payment-name">Name</label>
                        <input type="text" id="payment-name" required>
                    </div>
                    
                    
                    <div class="form-group">
                        <label for="payment-paid">Paid Amount (₹)</label>
                        <input type="number" id="payment-paid" required>
                    </div>
                    <div class="form-group">
                        <label for="payment-remain">Remain Amount (₹)</label>
                        <input type="number" id="payment-remain" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="payment-total">Total Amount (₹)</label>
                        <input type="number" id="payment-total" required>
                    </div>
                    
                    <button type="submit" style="padding:10px 20px; background:#1a6fc4; color:white; border:none; border-radius:5px; cursor:pointer;">
                        Submit
                    </button>
                </form>
            </div>
            
            <!-- ✅ Payment Records Table -->
            <div class="table-container" style="margin-top:20px;">
                <h3 style="margin:10px 0;">Payment Records</h3>
                <table id="payment-table" style="display:none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Day</th>
                            <th>Paid Amount (₹)</th>
                            <th>Remain</th>
                            <th>Total Amount (₹)</th>
                            
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payment-body"></tbody>
                </table>
            </div>
        </div>
    </div>
   <footer>
    <div class="contain">
    <p>&copy; 2025 Tractor Fleet Management || Designed By <span>Uttra Patel</span><br />
    <p1>session expired is <span id="counter">0s</span></p1></p>
    </div>
  </footer>
  <script src="session.js"></script>
    <script>
    
const supabaseUrl = 'https://iydamvrlxtwsnqvflaxq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZGFtdnJseHR3c25xdmZsYXhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTczMTIsImV4cCI6MjA3MzY3MzMxMn0.Z8m6XGyu9wsN_UJ8EZYr12BRemsO12_U8EEZ9JizQ6w';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Get ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const user_id= urlParams.get('id');
        console.log(user_id)
        // DOM elements
        const loadingElement = document.getElementById('loading');
        const errorElement = document.getElementById('error');
        const fleetTable = document.getElementById('fleet-table');
        const tableBody = document.getElementById('table-body');
        const totalRunningTimeElement = document.getElementById('total-running-time');
        const totalAmountElement = document.getElementById('total-amount');
        const totalAmountInput = document.getElementById('total-amount-input');
        const paidAmountInput = document.getElementById('paid-amount');
        const calculatorResult = document.getElementById('calculator-result');
        const tm = 15;
        
        // Format number as Indian currency
        function formatIndianCurrency(amount) {
            return '₹' + amount.toFixed(0).replace(/\d(?=(\d{2})+\.)/g, '$&,');
        }
        
        // Fetch fleet data from Supabase
        async function fetchFleetData() {
            if (!user_id) {
                showError('No fleet ID provided in URL');
                return;
            }
            
            try {
                // Fetch data from Supabase
                const { data, error } = await supabase
                    .from('admin-fleet')
                    .select('*')
                    .eq('user_id', user_id);
                
                if (error) {
                    throw error;
                }
                

                // Display data in table
                displayData(data);
                
                // Calculate and display totals
                calculateTotals(data);
                
            } catch (error) {
                showError('Error fetching data: ' + error.message);
            }
        }
        
        // Display data in table
        function displayData(data) {
            tableBody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                const pay = Number(item.running_time * tm );
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.user_id}</td>
                    <td>${item.name || 'N/A'}</td>
                    <td>${formatDate(item.date)}</td>
                    <td>${getDayOfWeek(item.date)}</td>
                    <td>${item.running_time || 0}</td>
                    <td>${pay}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            loadingElement.style.display = 'none';
            fleetTable.style.display = 'table';
        }
        
        // Calculate totals
        function calculateTotals(data) {
            const totalRunningTime = data.reduce((sum, item) => sum + (parseInt(item.running_time) || 0), 0);
            const totalAmount = totalRunningTime * tm; // ₹150 per hour
            
            totalRunningTimeElement.textContent = `${totalRunningTime.toFixed(0)} Minutes`;
            totalAmountElement.textContent = formatIndianCurrency(totalAmount);
            totalAmountInput.value = totalAmount.toFixed(0);
            
            // Update calculator when paid amount changes
            paidAmountInput.addEventListener('input', updateCalculator);
            updateCalculator(); // Initial calculation
        }
        
        // Update calculator
        function updateCalculator() {
            const totalAmount = parseInt(totalAmountInput.value) || 0;
            const paidAmount = parseInt(paidAmountInput.value) || 0;
            const remainingAmount = totalAmount - paidAmount;
            
            calculatorResult.textContent = `Remaining amount: ${formatIndianCurrency(remainingAmount)}`;
            
            if (remainingAmount < 0) {
                calculatorResult.style.color = '#e74c3c';
            } else {
                calculatorResult.style.color = '#2c3e50';
            }
        }
        
        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        // Get day of week
        function getDayOfWeek(dateString) {
            if (!dateString) return 'N/A';
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const date = new Date(dateString);
            return days[date.getDay()];
        }
        
        // Show error
        function showError(message) {
            loadingElement.style.display = 'none';
            errorElement.style.display = 'block';
            errorElement.textContent = message;
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', fetchFleetData);
        
        
        
        
        
        const paymentForm = document.getElementById("payment-form");
        const paymentTable = document.getElementById("payment-table");
        const paymentBody = document.getElementById("payment-body");
        
        // ✅ Insert or Update Payment
        paymentForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const id = parseInt(document.getElementById("payment-id").value);
            const user_id = parseInt(document.getElementById("payment-id2").value);
            const name = document.getElementById("payment-name").value;
            const remain = parseInt(document.getElementById("payment-remain").value);
            const paid_amount = parseInt(document.getElementById("payment-paid").value);
            let total_amount = parseInt(document.getElementById("payment-total").value);
            
            total_amount = paid_amount + remain;
            // ✅ Auto Date + Day
            const today = new Date();
            const date = today.toISOString().split("T")[0]; // YYYY-MM-DD
            const day = today.toLocaleDateString("en-US", { weekday: "long" }); // e.g. Thursday
            
            const { error } = await supabase
                .from("admin-singePay")
                .upsert([{ id, user_id, name, paid_amount, remain, total_amount, date, day }]);
            
            if (error) {
                alert("❌ Error: " + error.message);
            } else {
                alert("✅ Payment record saved!");
                paymentForm.reset();
            }
        });
        
        
        
        async function fetchPayData() {
    if (!user_id) {
        showError('No fleet ID provided in URL');
        return;
    }

    try {
        const { data, error } = await supabase
            .from('admin-singePay')
            .select('*')
            .eq('user_id', user_id);  // ✅ correct filter

        if (error) throw error;

        console.log("user_id from URL:", user_id);
        console.log("Payments fetched:", data);



        // ✅ Display only matching payments
        fetchPayments(data);

        // ✅ Optional: Calculate total 

    } catch (error) {
        showError('Error fetching data: ' + error.message);
    }
}

        
        
        
       // ✅ OPTION 1: Edit button mein user_id add karna (BEST SOLUTION)
async function fetchPayments(data) {
    paymentBody.innerHTML = "";

    if (!data || !Array.isArray(data) || data.length === 0) {
        paymentTable.style.display = "none";
        return;
    }

    paymentTable.style.display = "table";

    data.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.user_id}</td>
            <td>${item.name}</td>
            <td>${item.date || "-"}</td>
            <td>${item.day || "-"}</td>
            <td>₹${item.paid_amount}</td>
            <td>₹${item.remain}</td>
            <td>₹${item.total_amount}</td>
            <td class="actions">
                <button class="btn btn-edit btn-sm" onclick="editItem(${item.id}, '${item.name}', ${item.paid_amount}, ${item.remain}, ${item.total_amount}, ${item.user_id})">Edit</button>
                <button class="btn btn-delete btn-sm" onclick="deleteItem(${item.id})">Delete</button>
            </td>
        `;
        paymentBody.appendChild(row);
    });
}

// ✅ EDIT FUNCTION - sab parameters sahi se milenge
function editItem(id, name, paid, remain, total, user_id) {
    console.log('Editing item:', { id, name, paid, remain, total, user_id });
    
    document.getElementById("payment-id").value = id;
    document.getElementById("payment-id2").value = user_id;
    document.getElementById("payment-name").value = name;
    document.getElementById("payment-paid").value = paid;
    document.getElementById("payment-remain").value = remain;
    document.getElementById("payment-total").value = total;
    
    document.getElementById("payment-form").scrollIntoView({ behavior: 'smooth' });
}

        
        // ✅ Delete Payment
        async function deleteItem(id) {
            if (!confirm("Are you sure you want to delete this record?")) return;
            
            const { error } = await supabase
                .from("admin-singePay")
                .delete()
                .eq("id", id);
            
            if (error) {
                alert("❌ Delete Error: " + error.message);
            } else {
                alert("🗑️ Record deleted!");
                fetchPayData(); // fetch again for this fleet
            }
        }
        
        // ✅ Load Payments Initially
        document.addEventListener("DOMContentLoaded",fetchPayData);
    </script>
</body>

</html>
